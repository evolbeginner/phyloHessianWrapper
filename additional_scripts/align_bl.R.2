#! /bin/env Rscript

suppressPackageStartupMessages(
    suppressWarnings({
        library(phytools)
        library(phangorn)
    })
)

args <- commandArgs(trailingOnly = TRUE)

if (length(args) < 2) {
    stop("Usage: <script> <tree_file> <branch_table>")
}

treefile <- args[1]
branch_out_infile <- args[2]

if (!file.exists(treefile)) {
    stop("Tree file not found: ", treefile)
}
if (!file.exists(branch_out_infile)) {
    stop("Branch table file not found: ", branch_out_infile)
}

trees <- read.tree(treefile)
if (inherits(trees, "multiPhylo")) {
    tree_list <- trees
} else {
    tree_list <- list(trees)
}
rm(trees)

branch_df_template <- read.table(
    branch_out_infile,
    header = FALSE,
    stringsAsFactors = FALSE,
    quote = "",
    comment.char = ""
)
colnames(branch_df_template) <- c("branch", "bl")
branch_df_template$tree_order <- seq_len(nrow(branch_df_template))

new_sort <- function(v) {
    if (length(v) == 0) return(v)
    v[order(tolower(v), method = "radix")]
}

process_single_tree <- function(phy, tree_idx, branch_template) {
    nb.tip  <- length(phy$tip.label)
    nb.node <- phy$Nnode

    node_ids <- (nb.tip + 1):(nb.tip + nb.node)
    if (length(node_ids) == 0) {
        stop("Tree ", tree_idx, " has no internal nodes.")
    }

    all_children <- Children(phy, node_ids)

    branches <- character(nrow(phy$edge))
    b_idx <- 0L

    for (i in length(node_ids):1) {
        children <- all_children[[i]]
        if (is.null(children) || length(children) == 0) next

        for (child in children) {
            tips <- Descendants(phy, child, type = "tip")
            tips_vec <- if (is.list(tips)) unlist(tips, use.names = FALSE) else tips

            tip_names <- new_sort(phy$tip.label[tips_vec])
            tip_name <- paste(tip_names, collapse = "-")

            comp_tip_names <- new_sort(phy$tip.label[!(phy$tip.label %in% tip_names)])
            comp_tip_name <- paste(comp_tip_names, collapse = "-")

            branch <- paste(new_sort(c(tip_name, comp_tip_name)), collapse = ",")
            b_idx <- b_idx + 1L
            branches[b_idx] <- branch
        }
    }

    if (b_idx != length(phy$edge.length)) {
        stop(
            "Tree ", tree_idx, ": enumerated ", b_idx,
            " branches but tree has ", length(phy$edge.length), " edges."
        )
    }
    branches <- branches[seq_len(b_idx)]

    df <- branch_template
    df$tree_index <- tree_idx

    df$ape_order <- vapply(
        seq_len(nrow(df)),
        function(i) {
            branch <- df$branch[i]
            parts <- strsplit(branch, ",", fixed = TRUE)[[1]]
            alt_branch <- paste(rev(parts), collapse = ",")
            idx <- which(branches == branch | branches == alt_branch)
            if (length(idx) == 0) return(NA_integer_)
            idx[1]
        },
        integer(1),
        USE.NAMES = FALSE
    )

    if (anyNA(df$ape_order)) {
        missing <- unique(df$branch[is.na(df$ape_order)])
        stop(
            "Tree ", tree_idx,
            ": could not match the following branches: ",
            paste(missing, collapse = ", ")
        )
    }

    df$bl <- phy$edge.length[df$ape_order]

    df[, c("tree_index", "branch", "bl", "tree_order", "ape_order")]
}

results <- lapply(seq_along(tree_list), function(idx) {
    process_single_tree(tree_list[[idx]], idx, branch_df_template)
})

combined_df <- do.call(rbind, results)
combined_df <- combined_df[order(combined_df$tree_index, combined_df$branch), ]
row.names(combined_df) <- NULL

write.table(
    combined_df,
    sep = "\t",
    quote = FALSE,
    row.names = FALSE
)

for (df in results) {
    ordered_bl <- df[order(df$ape_order), "bl"]
    cat(paste(ordered_bl, collapse = ","), "\n", sep = "")
}

